name: Generic Docker Image Mirror

on:
  workflow_call:
    inputs:
      source_image:
        required: true
        type: string
        description: "Source Docker image to mirror (e.g. docker.io/library/busybox)"
      target_package:
        required: true
        type: string
        description: "Target package name without registry (e.g. owner/image)"
      tag:
        required: true
        type: string
        description: "Version tag of the source image to mirror"

env: 
    registry: ghcr.io

jobs:
  mirror:
    runs-on: ubuntu-latest

    permissions:
      packages: write
      contents: read

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.registry }} -u ${{ github.actor }} --password-stdin

      - name: Check if version already exists
        id: check_exists
        run: |
          VERSION=${{ inputs.tag }}
          if docker buildx imagetools inspect ${{ env.registry }}/${{ inputs.target_package }}:$VERSION >/dev/null 2>&1; then
            echo "Image tag $VERSION already exists. Skipping push."
            echo "skip_push=true" >> $GITHUB_OUTPUT
          else
            echo "Image tag $VERSION not found. Proceeding with push."
            echo "skip_push=false" >> $GITHUB_OUTPUT
          fi

      - name: Tag and push to registry
        if: steps.check_exists.outputs.skip_push == 'false'
        run: |
          VERSION=${{ inputs.tag }}
          # Copy manifest list and all referenced manifests with exponential backoff
          MAX_RETRIES=5
          BASE_DELAY=15
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i of $MAX_RETRIES..."
            if docker buildx imagetools create \
              --tag ${{ env.registry }}/${{ inputs.target_package }}:$VERSION \
              ${{ inputs.source_image }}:$VERSION; then
              echo "Successfully pushed image"
              break
            else
              if [ $i -lt $MAX_RETRIES ]; then
                # Exponential backoff: delay increases with each retry
                DELAY=$((BASE_DELAY * (2 ** (i - 1))))
                echo "Push failed (possibly rate limited), retrying in ${DELAY}s..."
                sleep $DELAY
              else
                echo "Failed after $MAX_RETRIES attempts"
                exit 1
              fi
            fi
          done
          
          # Verify the copy
          docker buildx imagetools inspect ${{ env.registry }}/${{ inputs.target_package }}:$VERSION